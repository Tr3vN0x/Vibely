<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vibely – Full Social App</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <style>
        :root { --blue: #1877f2; --bg: #f0f2f5; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #1c1e21; }
        header { background: var(--blue); color: #fff; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        nav { display: flex; gap: 8px; }
        nav button { background: rgba(255,255,255,.2); color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        nav button:hover { background: rgba(255,255,255,.4); }
        .container { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; padding: 20px; max-width: 1200px; margin: auto; }
        .card { background: #fff; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.1); }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; }
        button.primary { background: var(--blue); color: white; width: 100%; font-weight: bold; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }
        .hidden { display: none; }
        .post-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .badge { color: #1877f2; font-size: 12px; }
        .post img, .post video { width: 100%; border-radius: 8px; margin-top: 10px; display: block; }
        .reel-item { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        @media(max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <b style="font-size: 1.5rem;">Vibely</b>
    <nav id="nav-links" class="hidden">
        <button onclick="showTab('feed')">Feed</button>
        <button onclick="showTab('reels')">Reels</button>
        <button onclick="logout()">Logout</button>
    </nav>
</header>

<div id="auth" class="card" style="max-width: 400px; margin: 80px auto;">
    <h2 style="text-align: center;">Welcome to Vibely</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button class="primary" onclick="login()" style="margin-bottom: 10px;">Login</button>
    <button onclick="register()" style="width: 100%; background: none; color: var(--blue); border: none; cursor: pointer;">Create new account</button>
    <p id="authError" style="color: red; font-size: 12px; text-align: center;"></p>
</div>

<div id="app" class="hidden">
    <div class="container">
        
        <aside>
            <div class="card">
                <h3>Profile</h3>
                <input id="username" placeholder="Display Name" />
                <label style="font-size: 13px; display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="verified" /> Verified Account
                </label>
                <button class="primary" onclick="saveProfile()">Update Profile</button>
            </div>
        </aside>

        <main>
            <div id="feed" class="tab">
                <div class="card">
                    <textarea id="postText" placeholder="What's happening?"></textarea>
                    <input type="file" id="imageUpload" accept="image/*" />
                    <button class="primary" onclick="createPost()">Post</button>
                </div>
                <div id="posts"></div>
            </div>

            <div id="reels" class="tab hidden">
                <div class="card">
                    <h3>Upload Reel</h3>
                    <input type="file" id="videoUpload" accept="video/*" />
                    <button class="primary" onclick="uploadReel()">Upload Video</button>
                </div>
                <div id="reelFeed"></div>
            </div>
        </main>

        <aside>
            <div class="card">
                <h4>Global Chat</h4>
                <div id="chat" style="height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; font-size: 14px;"></div>
                <input id="chatText" placeholder="Type a message..." />
                <button class="primary" onclick="sendMessage()">Send</button>
            </div>
        </aside>

    </div>
</div>

<script>
// REPLACE WITH YOUR ACTUAL CONFIG IF DIFFERENT
const firebaseConfig = {
    apiKey: "AIzaSyCDll8RH1kzGOf-ixJmSlHXGssOHSMlO3s",
    authDomain: "vibely-5128e.firebaseapp.com",
    projectId: "vibely-5128e",
    storageBucket: "vibely-5128e.firebasestorage.app",
    messagingSenderId: "1048550825812",
    appId: "1:1048550825812:web:fc5bbba51e065807ffb2c1"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Auth Listener
auth.onAuthStateChanged(user => {
    if(user) {
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('nav-links').classList.remove('hidden');
        loadUserData();
        loadFeed();
        loadChat();
        loadReels();
    } else {
        document.getElementById('auth').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
        document.getElementById('nav-links').classList.add('hidden');
    }
});

function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
    document.getElementById(tabId).classList.remove('hidden');
}

// Authentication
function register() {
    auth.createUserWithEmailAndPassword(email.value, password.value).catch(e => authError.innerText = e.message);
}
function login() {
    auth.signInWithEmailAndPassword(email.value, password.value).catch(e => authError.innerText = e.message);
}
function logout() { auth.signOut(); }

// Profile Management
function loadUserData() {
    db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
        if(doc.exists) {
            document.getElementById('username').value = doc.data().username || "";
            document.getElementById('verified').checked = doc.data().verified || false;
        }
    });
}

function saveProfile() {
    db.collection('users').doc(auth.currentUser.uid).set({
        username: document.getElementById('username').value,
        verified: document.getElementById('verified').checked
    }, {merge: true}).then(() => alert("Profile Saved!"));
}

// Feed Logic
async function createPost() {
    const text = postText.value;
    const file = imageUpload.files[0];
    const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
    const userData = userDoc.data() || {username: "Anonymous"};

    let url = null;
    if(file) {
        const ref = storage.ref('images/' + Date.now() + "_" + file.name);
        const upload = await ref.put(file);
        url = await upload.ref.getDownloadURL();
    }

    db.collection('posts').add({
        text,
        image: url,
        uid: auth.currentUser.uid,
        username: userData.username,
        isVerified: userData.verified || false,
        likes: 0,
        created: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    postText.value = '';
    imageUpload.value = '';
}

function loadFeed() {
    db.collection('posts').orderBy('created', 'desc').onSnapshot(snapshot => {
        const postsDiv = document.getElementById('posts');
        postsDiv.innerHTML = '';
        snapshot.forEach(doc => {
            const p = doc.data();
            postsDiv.innerHTML += `
                <div class="card post">
                    <div class="post-header">
                        <strong>${p.username || 'User'}</strong> 
                        ${p.isVerified ? '<span class="badge">✔ Verified</span>' : ''}
                    </div>
                    <p>${p.text || ''}</p>
                    ${p.image ? `<img src="${p.image}">` : ''}
                    <hr>
                    <button onclick="likePost('${doc.id}')">❤️ ${p.likes || 0}</button>
                </div>`;
        });
    });
}

function likePost(id) {
    db.collection('posts').doc(id).update({ likes: firebase.firestore.FieldValue.increment(1) });
}

// Reels Logic
async function uploadReel() {
    const file = videoUpload.files[0];
    if(!file) return alert("Select a video");
    
    const ref = storage.ref('reels/' + Date.now() + "_" + file.name);
    const upload = await ref.put(file);
    const url = await upload.ref.getDownloadURL();
    
    db.collection('reels').add({
        url,
        uid: auth.currentUser.uid,
        created: firebase.firestore.FieldValue.serverTimestamp()
    });
    videoUpload.value = '';
}

function loadReels() {
    db.collection('reels').orderBy('created', 'desc').onSnapshot(snapshot => {
        const reelFeed = document.getElementById('reelFeed');
        reelFeed.innerHTML = '';
        snapshot.forEach(doc => {
            const r = doc.data();
            reelFeed.innerHTML += `
                <div class="card reel-item">
                    <video src="${r.url}" controls style="max-height: 400px; background: #000;"></video>
                </div>`;
        });
    });
}

// Chat Logic
function sendMessage() {
    const txt = chatText.value;
    if(!txt) return;
    db.collection('chat').add({
        text: txt,
        user: auth.currentUser.email,
        created: firebase.firestore.FieldValue.serverTimestamp()
    });
    chatText.value = '';
}

function loadChat() {
    db.collection('chat').orderBy('created').limitToLast(20).onSnapshot(snapshot => {
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        snapshot.forEach(doc => {
            const c = doc.data();
            chatDiv.innerHTML += `<div><b>${c.user?.split('@')[0]}:</b> ${c.text}</div>`;
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
    });
}
</script>
</body>
</html>
