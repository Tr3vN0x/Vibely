<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibely | Winter Diamond Lounge</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #d4af37;
            --ice-blue: #a5f3fc;
            --obsidian: #05050a;
            --mythic: linear-gradient(45deg, #ff00ea, #00d4ff);
            --glass: rgba(255, 255, 255, 0.05);
        }
        * { box-sizing: border-box; transition: all 0.3s ease; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #080a12; color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Mythic Animations */
        @keyframes mythicPulse {
            0% { box-shadow: 0 0 10px #ff00ea; }
            50% { box-shadow: 0 0 25px #00d4ff; }
            100% { box-shadow: 0 0 10px #ff00ea; }
        }

        .snowflake { 
            color: #a5f3fc; text-shadow: 0 0 8px #a5f3fc; position: fixed; top: -10%; z-index: 999; 
            animation: fall linear infinite; pointer-events: none; opacity: 0.8; 
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        header { padding: 15px 40px; background: rgba(5, 5, 10, 0.95); border-bottom: 1px solid rgba(165, 243, 252, 0.2); display: flex; justify-content: space-between; align-items: center; z-index:2; }
        
        .main-layout { display: grid; grid-template-columns: 240px 1fr 320px; flex-grow: 1; overflow: hidden; position: relative; }
        
        /* Sidebar */
        .nav-sidebar { padding: 25px 15px; background: rgba(0,0,0,0.5); border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 10px; backdrop-filter: blur(8px); }
        .nav-btn { background: var(--glass); border: 1px solid transparent; color: #aaa; padding: 12px 20px; font-family: 'Cinzel', serif; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .nav-btn:hover, .nav-btn.active { color: var(--ice-blue); border-color: var(--ice-blue); background: rgba(165, 243, 252, 0.1); }

        #centerContent { overflow-y: auto; padding: 40px; background: radial-gradient(circle at top, #0c1220 0%, #05050a 100%); flex-grow: 1; }
        .view-section { display: none; max-width: 1000px; margin: 0 auto; }

        /* Card Effects */
        .user-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; position: relative; }
        .effect-mythic-glow { animation: mythicPulse 3s infinite; border: 2px solid #00d4ff !important; }
        .effect-frost-border { border: 2px solid var(--ice-blue); box-shadow: 0 0 15px var(--ice-blue); }
        .effect-sparkle-aura { box-shadow: inset 0 0 20px rgba(165,243,252,0.3); }

        /* Shop Styles */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .shop-card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--ice-blue); }
        .shop-card.mythic { border-top: 4px solid #ff00ea; background: linear-gradient(to bottom, #1a051a, #111); }
        .cost { color: var(--gold); font-weight: bold; margin: 10px 0; }

        /* Chat */
        .right-sidebar { background: #05050a; border-left: 1px solid #222; display: flex; flex-direction: column; padding: 15px; }
        #chatBox { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; }
        .chat-msg { font-size: 0.85rem; margin-bottom: 5px; padding: 5px; background: #111; border-radius: 4px; }
        
        #loginOverlay { position: fixed; inset: 0; background: #080a12; z-index: 2000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div style="text-align:center; background: #000; padding: 40px; border-radius: 15px; border: 1px solid var(--ice-blue);">
        <h2 style="font-family:'Cinzel'; color:var(--ice-blue);">WINTER LOUNGE</h2>
        <input id="regName" placeholder="Username" style="display:none;">
        <input id="authEmail" type="email" placeholder="Email">
        <input id="authPass" type="password" placeholder="Password">
        <button class="nav-btn" style="width:100%;" onclick="handleAuth()">ENTER</button>
        <p onclick="toggleMode()" style="font-size:0.7rem; cursor:pointer; color:#666; margin-top:10px;">Switch Login/Register</p>
    </div>
</div>

<header>
    <div style="font-family:'Cinzel'; color:var(--ice-blue); letter-spacing:3px;">❄ DIAMOND LOUNGE</div>
    <div id="headerBalance" style="color:var(--gold); font-weight:bold;">♦ 0</div>
</header>

<div id="mainView" class="main-layout" style="display:none">
    <nav class="nav-sidebar">
        <button class="nav-btn active" id="btn-explore" onclick="switchTab('explore')">Lounge</button>
        <button class="nav-btn" id="btn-wheel" onclick="switchTab('wheel')">Frost Vault</button>
        <button class="nav-btn" id="btn-shop" onclick="switchTab('shop')">Winter Shop</button>
        <button class="nav-btn" id="btn-inventory" onclick="switchTab('inventory')">Inventory</button>
        <button class="nav-btn" id="btn-profile" onclick="switchTab('profile')">Profile</button>
        <button class="nav-btn" style="margin-top:auto; color:crimson;" onclick="auth.signOut()">Logout</button>
    </nav>

    <main id="centerContent">
        <section id="view-explore" class="view-section" style="display:block;">
            <div id="cardsContainer" class="shop-grid"></div>
        </section>

        <section id="view-shop" class="view-section">
            <h2 style="font-family:'Cinzel'; text-align:center;">Diamond Emporium</h2>
            <div id="shopContainer" class="shop-grid"></div>
        </section>

        <section id="view-inventory" class="view-section">
            <h2 style="font-family:'Cinzel'; text-align:center;">Your Treasures</h2>
            <div id="inventoryContainer" class="shop-grid"></div>
        </section>

        <section id="view-wheel" class="view-section" style="text-align:center;">
            <div id="wheel" style="width:300px; height:300px; border-radius:50%; border:5px solid var(--ice-blue); margin: 20px auto; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); background: conic-gradient(#111 0deg, #222 45deg, #111 90deg, #222 135deg, #111 180deg, #222 225deg, #111 270deg, #222 315deg);"></div>
            <button class="nav-btn" id="spinBtn" onclick="spinWheel()">Spin Vault (Daily)</button>
        </section>
        
        <section id="view-profile" class="view-section">
            <div style="background:var(--glass); padding:20px; border-radius:10px;">
                <h3>Edit Identity</h3>
                <input id="newAvatar" placeholder="Avatar Image URL">
                <input id="newBadge" placeholder="Custom Badge">
                <button class="nav-btn" onclick="updateProfile()">Update Profile</button>
            </div>
        </section>
    </main>

    <aside class="right-sidebar">
        <div id="chatBox"></div>
        <input id="chatInput" placeholder="Send a message..." onkeypress="if(event.key==='Enter') sendChat()" style="background:#111; border:1px solid #333; color:#fff; padding:10px;">
    </aside>
</div>

<script>
// INITIALIZE FIREBASE
const firebaseConfig = { apiKey:"AIzaSyCDll8RH1kzGOf-ixJmSlHXGssOHSMlO3s", authDomain:"vibely-5128e.firebaseapp.com", projectId:"vibely-5128e", storageBucket:"vibely-5128e.firebasestorage.app", messagingSenderId:"1048550825812", appId:"1:1048550825812:web:fc5bbba51e065807ffb2c1" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let isLogin = true;
let myProfile = null;

// SHOP DATA
const shopItems = [
    { id: 'f_border', name: 'Frost Border', cost: 150, type: 'border', desc: 'A chilled blue glow.' },
    { id: 's_aura', name: 'Sparkle Aura', cost: 300, type: 'aura', desc: 'Magic particles.' },
    { id: 'm_god', name: 'MYTHIC: Winter God', cost: 1000, type: 'mythic', desc: 'Ultimate animated card effect.' },
    { id: 'b_starter', name: 'Newcomer Bundle', cost: 200, type: 'bundle', desc: 'Includes Badge + 100 XP', items: ['badge_new', 'xp_100'] }
];

/* Auth Logic */
function toggleMode() { isLogin = !isLogin; document.getElementById('regName').style.display = isLogin ? 'none' : 'block'; }

async function handleAuth() {
    const e = document.getElementById('authEmail').value;
    const p = document.getElementById('authPass').value;
    const n = document.getElementById('regName').value;
    try {
        if (isLogin) await auth.signInWithEmailAndPassword(e, p);
        else {
            const res = await auth.createUserWithEmailAndPassword(e, p);
            await db.collection('users').doc(res.user.uid).set({
                name: n, vibes: 50, xp: 0, avatar: "", badge: "❄️ Villager", inventory: [], equipped: []
            });
        }
    } catch (err) { alert(err.message); }
}

auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainView').style.display = 'grid';
        loadApp(user.uid);
    }
});

/* App Logic */
function loadApp(uid) {
    // Sync User Data
    db.collection('users').doc(uid).onSnapshot(doc => {
        myProfile = doc.data();
        document.getElementById('headerBalance').innerText = `♦ ${myProfile.vibes}`;
        renderShop();
        renderInventory();
    });

    // Sync Lounge Cards
    db.collection('users').onSnapshot(snap => {
        const cont = document.getElementById('cardsContainer');
        cont.innerHTML = '';
        snap.forEach(d => {
            const u = d.data();
            const isMythic = u.equipped?.includes('m_god');
            const hasFrost = u.equipped?.includes('f_border');
            
            cont.innerHTML += `
                <div class="user-card ${isMythic ? 'effect-mythic-glow' : ''} ${hasFrost ? 'effect-frost-border' : ''}">
                    <img src="${u.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+u.name}" style="width:60px; border-radius:50%">
                    <div style="font-family:Cinzel; color:var(--ice-blue);">${u.name}</div>
                    <div style="font-size:0.7rem; color:var(--gold);">${u.badge || ''}</div>
                    <div style="font-size:0.6rem;">Lvl ${Math.floor(u.xp/100)+1}</div>
                </div>`;
        });
    });
}

function renderShop() {
    const cont = document.getElementById('shopContainer');
    cont.innerHTML = '';
    shopItems.forEach(item => {
        const owned = myProfile.inventory?.includes(item.id);
        cont.innerHTML += `
            <div class="shop-card ${item.type === 'mythic' ? 'mythic' : ''}">
                <div style="color:white; font-weight:bold;">${item.name}</div>
                <div style="font-size:0.7rem; color:#888;">${item.desc}</div>
                <div class="cost">♦ ${item.cost}</div>
                <button class="nav-btn" onclick="buyItem('${item.id}', ${item.cost})" ${owned ? 'disabled' : ''}>
                    ${owned ? 'Owned' : 'Purchase'}
                </button>
            </div>`;
    });
}

async function buyItem(id, cost) {
    if (myProfile.vibes < cost) return alert("Insufficient Diamonds!");
    
    await db.collection('users').doc(auth.currentUser.uid).update({
        vibes: firebase.firestore.FieldValue.increment(-cost),
        inventory: firebase.firestore.FieldValue.arrayUnion(id)
    });
    
    alert("Thanks for your purchase! Item added to inventory.");
}

function renderInventory() {
    const cont = document.getElementById('inventoryContainer');
    cont.innerHTML = '';
    if (!myProfile.inventory) return;

    myProfile.inventory.forEach(itemId => {
        const item = shopItems.find(i => i.id === itemId) || { name: "Special Item", type: "misc" };
        const isEquipped = myProfile.equipped?.includes(itemId);
        
        cont.innerHTML += `
            <div class="shop-card">
                <div>${item.name}</div>
                <button class="nav-btn" onclick="toggleEquip('${itemId}')">
                    ${isEquipped ? 'Unequip' : 'Equip'}
                </button>
            </div>`;
    });
}

async function toggleEquip(id) {
    const isEquipped = myProfile.equipped?.includes(id);
    const action = isEquipped ? 
        firebase.firestore.FieldValue.arrayRemove(id) : 
        firebase.firestore.FieldValue.arrayUnion(id);

    await db.collection('users').doc(auth.currentUser.uid).update({ equipped: action });
}

function switchTab(t) {
    document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
    document.getElementById('view-' + t).style.display = 'block';
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + t).classList.add('active');
}

/* Chat functionality */
function sendChat() {
    const msg = document.getElementById('chatInput').value;
    if (!msg) return;
    db.collection('chat').add({ 
        user: myProfile.name, 
        text: msg, 
        time: firebase.firestore.FieldValue.serverTimestamp() 
    });
    document.getElementById('chatInput').value = '';
}

db.collection('chat').orderBy('time', 'desc').limit(15).onSnapshot(s => {
    const box = document.getElementById('chatBox');
    box.innerHTML = '';
    s.docs.reverse().forEach(d => {
        box.innerHTML += `<div class="chat-msg"><b>${d.data().user}:</b> ${d.data().text}</div>`;
    });
    box.scrollTop = box.scrollHeight;
});

/* Simple Wheel Spin */
function spinWheel() {
    const deg = 720 + Math.floor(Math.random() * 360);
    document.getElementById('wheel').style.transform = `rotate(${deg}deg)`;
    setTimeout(() => {
        alert("You found 10 Diamonds in the vault!");
        db.collection('users').doc(auth.currentUser.uid).update({
            vibes: firebase.firestore.FieldValue.increment(10)
        });
    }, 4000);
}

async function updateProfile() {
    const avatar = document.getElementById('newAvatar').value;
    const badge = document.getElementById('newBadge').value;
    await db.collection('users').doc(auth.currentUser.uid).update({ avatar, badge });
    alert("Profile Updated!");
}

/* Snowflake Generator */
setInterval(() => {
    const s = document.createElement('div');
    s.className = 'snowflake';
    s.innerHTML = '❄';
    s.style.left = Math.random() * 100 + 'vw';
    s.style.animationDuration = (Math.random() * 3 + 2) + 's';
    document.body.appendChild(s);
    setTimeout(() => s.remove(), 5000);
}, 300);

</script>
</body>
</html>
